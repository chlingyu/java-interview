# 07 - Java é›†åˆ

> è¦†ç›– Java é›†åˆæ¡†æ¶æ ¸å¿ƒçŸ¥è¯†ï¼šArrayListã€LinkedListã€HashMapã€ConcurrentHashMap ç­‰é«˜é¢‘é¢è¯•è€ƒç‚¹ã€‚Map éƒ¨åˆ†æ˜¯é¢è¯•é‡ç¾åŒºï¼ŒHashMap å‡ ä¹æ¯åœºå¿…é—®ã€‚

---

## ä¸€ã€List

### 1. ArrayList å’Œ LinkedList çš„åŒºåˆ«ï¼Ÿ

> â­â­â­â­ é«˜é¢‘ | éš¾åº¦ï¼šâ­â­

**å›ç­”**ï¼šç®€å•è¯´ï¼ŒArrayList æ˜¯"æ•°ç»„"ï¼ŒLinkedList æ˜¯"é“¾è¡¨"ã€‚æ•°ç»„æŸ¥å¾—å¿«ã€å¢åˆ æ…¢ï¼›é“¾è¡¨å¢åˆ å¿«ã€æŸ¥å¾—æ…¢â€”â€”ä½†è¿™åªæ˜¯ç†è®ºä¸Šçš„è¯´æ³•ï¼Œå®é™…åœºæ™¯ä¸­ ArrayList å‡ ä¹å…¨é¢ä¼˜äº LinkedListï¼Œå› ä¸º CPU ç¼“å­˜å¯¹è¿ç»­å†…å­˜éå¸¸å‹å¥½ã€‚

| å¯¹æ¯”é¡¹ | ArrayList | LinkedList |
|--------|-----------|------------|
| åº•å±‚ç»“æ„ | **åŠ¨æ€æ•°ç»„** | **åŒå‘é“¾è¡¨** |
| éšæœºè®¿é—®ï¼ˆ`get(i)`ï¼‰ | âš¡**O(1)**ï¼Œç›´æ¥æŒ‰ä¸‹æ ‡å®šä½ | O(n)ï¼Œè¦ä»å¤´ä¸€ä¸ªä¸ªæ‰¾ |
| å°¾éƒ¨æ·»åŠ ï¼ˆ`add(e)`ï¼‰ | âš¡**å‡æ‘Š O(1)** | O(1) |
| ä¸­é—´æ’å…¥/åˆ é™¤ | O(n)ï¼Œè¦æ¬ç§»åé¢çš„å…ƒç´  | O(n)ï¼Œæ‰¾åˆ°ä½ç½®åæ’å…¥æœ¬èº« O(1)ï¼Œä½†æ‰¾çš„è¿‡ç¨‹æ˜¯ O(n) |
| å†…å­˜å ç”¨ | ç´§å‡‘ï¼Œåªå­˜æ•°æ®æœ¬èº« | æ¯ä¸ªèŠ‚ç‚¹é¢å¤–å­˜ä¸¤ä¸ªæŒ‡é’ˆï¼ˆå‰é©± + åç»§ï¼‰ï¼Œâš¡**å†…å­˜å¼€é”€çº¦ä¸º ArrayList çš„ 3 å€** |

```java
// ArrayListï¼šåº•å±‚å°±æ˜¯ä¸€ä¸ª Object æ•°ç»„
Object[] elementData;

// LinkedListï¼šæ¯ä¸ªå…ƒç´ åŒ…è£…æˆä¸€ä¸ª Node èŠ‚ç‚¹
private static class Node<E> {
    E item;       // æ•°æ®
    Node<E> next; // åç»§æŒ‡é’ˆ
    Node<E> prev; // å‰é©±æŒ‡é’ˆ
}
```

> **å®é™…å¼€å‘å»ºè®®**ï¼šç»å¤§å¤šæ•°åœºæ™¯ç›´æ¥ç”¨ ArrayListã€‚LinkedList åªåœ¨"é¢‘ç¹åœ¨ä¸¤ç«¯å¢åˆ ã€å‡ ä¹ä¸éšæœºè®¿é—®"çš„åœºæ™¯ï¼ˆå¦‚å®ç°é˜Ÿåˆ—/åŒç«¯é˜Ÿåˆ—ï¼‰æ‰æœ‰ä¼˜åŠ¿ã€‚

---

### 2. ArrayList çš„æ‰©å®¹æœºåˆ¶ï¼Ÿ

> â­â­â­ å¸¸é—® | éš¾åº¦ï¼šâ­â­

**å›ç­”**ï¼šArrayList åº•å±‚æ˜¯æ•°ç»„ï¼Œæ•°ç»„æ»¡äº†å°±å¾—"æ¬å®¶"â€”â€”åˆ›å»ºä¸€ä¸ªæ›´å¤§çš„æ–°æ•°ç»„ï¼ŒæŠŠæ—§æ•°æ®å¤åˆ¶è¿‡å»ã€‚ä½ å¯ä»¥ç†è§£ä¸ºä½çš„æˆ¿å­å¤ªå°äº†ï¼Œæ¢ä¸€å¥—å¤§çš„ï¼Œç„¶åæŠŠå®¶å…·å…¨æ¬è¿‡å»ã€‚

**æ‰©å®¹æµç¨‹**ï¼š

1. åˆå§‹å®¹é‡ï¼š`new ArrayList()` æ—¶ï¼Œåº•å±‚æ•°ç»„å…¶å®æ˜¯ä¸ªâš¡**ç©ºæ•°ç»„**ï¼ˆJDK 7+ çš„æ‡’åˆå§‹åŒ–ï¼‰ï¼Œç¬¬ä¸€æ¬¡ `add` æ—¶æ‰æ‰©å®¹ä¸º âš¡**10**
2. ä»€ä¹ˆæ—¶å€™æ‰©å®¹ï¼šå½“å…ƒç´ ä¸ªæ•°è¶…è¿‡å½“å‰æ•°ç»„é•¿åº¦æ—¶è§¦å‘
3. æ‰©å®¹å¤šå°‘ï¼šæ–°å®¹é‡ = æ—§å®¹é‡ Ã— âš¡**1.5**ï¼ˆå‡†ç¡®è¯´æ˜¯ `oldCapacity + (oldCapacity >> 1)`ï¼Œå³ç§»ä¸€ä½å°±æ˜¯é™¤ä»¥ 2ï¼‰
4. æ€ä¹ˆæ¬ï¼šè°ƒç”¨ `Arrays.copyOf()` æŠŠæ—§æ•°ç»„æ•°æ®å¤åˆ¶åˆ°æ–°æ•°ç»„

```java
// JDK 8 æºç ç®€åŒ–ç‰ˆ
private void grow(int minCapacity) {
    int oldCapacity = elementData.length;
    int newCapacity = oldCapacity + (oldCapacity >> 1); // 1.5 å€
    elementData = Arrays.copyOf(elementData, newCapacity); // å¤åˆ¶åˆ°æ–°æ•°ç»„
}
```

> **é¢è¯•è¿½é—®**ï¼šå¦‚æœä½ æå‰çŸ¥é“è¦å­˜ 1000 ä¸ªå…ƒç´ ï¼Œæœ€å¥½ç”¨ `new ArrayList<>(1000)` æŒ‡å®šåˆå§‹å®¹é‡ï¼Œé¿å…åå¤æ‰©å®¹å¤åˆ¶å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚

---

## äºŒã€Map

### 3. HashMap çš„åº•å±‚æ•°æ®ç»“æ„ï¼Ÿ

> â­â­â­â­â­ å¿…è€ƒ | éš¾åº¦ï¼šâ­â­â­

**ä¸€å¥è¯å›ç­”**ï¼šJDK 8 çš„ HashMap åº•å±‚æ˜¯ **æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘**ã€‚

**é€šä¿—ç†è§£**ï¼š

æŠŠ HashMap æƒ³è±¡æˆä¸€ä¸ª"å¿«é€’æŸœ"ï¼š
- **æ•°ç»„** = å¿«é€’æŸœçš„æ ¼å­ï¼Œä¸€å…±æœ‰è‹¥å¹²ä¸ªç¼–å·ï¼ˆé»˜è®¤ âš¡**16** ä¸ªï¼‰
- **é“¾è¡¨** = å¦‚æœä¸¤ä¸ªå¿«é€’è¢«åˆ†åˆ°åŒä¸€ä¸ªæ ¼å­ï¼ˆå“ˆå¸Œå†²çªï¼‰ï¼Œå°±åœ¨è¿™ä¸ªæ ¼å­åé¢æ’é˜ŸæŒ‚ç€
- **çº¢é»‘æ ‘** = å¦‚æœæŸä¸ªæ ¼å­åé¢æ’çš„é˜Ÿå¤ªé•¿äº†ï¼ˆâš¡**â‰¥ 8 ä¸ª**ï¼‰ï¼Œå°±æŠŠé˜Ÿåˆ—å‡çº§æˆä¸€æ£µ"æŸ¥æ‰¾æ ‘"ï¼Œæ‰¾ä¸œè¥¿æ›´å¿«

**å›åˆ°æŠ€æœ¯**ï¼šä¸Šé¢è¯´çš„"æ ¼å­ç¼–å·"å°±æ˜¯ key çš„ hashCode å¯¹æ•°ç»„é•¿åº¦å–æ¨¡çš„ç»“æœï¼Œå†³å®šå…ƒç´ æ”¾åœ¨å“ªä¸ªä½ç½®ã€‚"æ’é˜Ÿ"å°±æ˜¯é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚"å‡çº§æˆæŸ¥æ‰¾æ ‘"å°±æ˜¯é“¾è¡¨è½¬çº¢é»‘æ ‘â€”â€”é“¾è¡¨æŸ¥æ‰¾æ˜¯ O(n)ï¼Œçº¢é»‘æ ‘æ˜¯ O(log n)ï¼Œå½“å†²çªä¸¥é‡æ—¶æ€§èƒ½å·®è·å¾ˆå¤§ã€‚

**åŸç†è¯¦è§£**ï¼š

```
HashMap åº•å±‚ç»“æ„ï¼ˆJDK 8ï¼‰

æ•°ç»„ï¼ˆNode[] tableï¼‰
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ 0 â”‚ 1 â”‚ 2 â”‚ 3 â”‚ 4 â”‚ 5 â”‚ 6 â”‚ 7 â”‚ ...
â””â”€â”¬â”€â”´â”€â”€â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
  â”‚       â”‚           â”‚
  â–¼       â–¼           â–¼
[K1,V1] [K3,V3]    [K5,V5]      â† é“¾è¡¨èŠ‚ç‚¹
  â”‚                   â”‚
  â–¼                   â–¼
[K2,V2]            [K6,V6]
                      â”‚
                      â–¼
                   [K7,V7]
                      â”‚  ï¼ˆé“¾è¡¨é•¿åº¦ â‰¥ 8 ä¸”æ•°ç»„é•¿åº¦ â‰¥ 64 â†’ è½¬çº¢é»‘æ ‘ï¼‰
                      â–¼
                   ğŸŒ³ çº¢é»‘æ ‘
```

**å…³é”®æ•°å­—**ï¼š

| å‚æ•° | å€¼ | å«ä¹‰ |
|------|-----|------|
| é»˜è®¤åˆå§‹å®¹é‡ | âš¡**16** | æ•°ç»„åˆå§‹é•¿åº¦ï¼Œå¿…é¡»æ˜¯ 2 çš„å¹‚ |
| é»˜è®¤è´Ÿè½½å› å­ | âš¡**0.75** | å…ƒç´ ä¸ªæ•°è¾¾åˆ°å®¹é‡ Ã— 0.75 æ—¶è§¦å‘æ‰©å®¹ |
| æ ‘åŒ–é˜ˆå€¼ | âš¡**8** | é“¾è¡¨é•¿åº¦ â‰¥ 8 æ—¶**å¯èƒ½**è½¬çº¢é»‘æ ‘ |
| æ ‘åŒ–æœ€å°å®¹é‡ | âš¡**64** | æ•°ç»„é•¿åº¦ â‰¥ 64 æ—¶æ‰çœŸæ­£æ ‘åŒ–ï¼Œå¦åˆ™ä¼˜å…ˆæ‰©å®¹ |
| é€€åŒ–é˜ˆå€¼ | âš¡**6** | çº¢é»‘æ ‘èŠ‚ç‚¹ â‰¤ 6 æ—¶é€€åŒ–å›é“¾è¡¨ |

> **ä¸ºä»€ä¹ˆæ ‘åŒ–é˜ˆå€¼æ˜¯ 8ï¼Ÿ** æ ¹æ®æ³Šæ¾åˆ†å¸ƒï¼Œåœ¨è´Ÿè½½å› å­ 0.75 çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ¡¶ä¸­å‡ºç° 8 ä¸ªå…ƒç´ çš„æ¦‚ç‡åªæœ‰ âš¡**0.00000006**ï¼ˆåƒä¸‡åˆ†ä¹‹å…­ï¼‰ï¼Œå±äºæç«¯æƒ…å†µã€‚é€‰ 8 æ˜¯åœ¨æ—¶é—´å’Œç©ºé—´ä¹‹é—´çš„å¹³è¡¡â€”â€”çº¢é»‘æ ‘èŠ‚ç‚¹å ç”¨çš„å†…å­˜æ˜¯é“¾è¡¨èŠ‚ç‚¹çš„ âš¡**2 å€**ï¼Œä¸å€¼å¾—åœ¨çŸ­é“¾è¡¨ä¸Šç”¨ã€‚

**ğŸ¤ é¢è¯•è¿™æ ·ç­”**ï¼š
> "JDK 8 çš„ HashMap åº•å±‚æ˜¯æ•°ç»„åŠ é“¾è¡¨åŠ çº¢é»‘æ ‘ã€‚é»˜è®¤æ•°ç»„é•¿åº¦ 16ï¼Œè´Ÿè½½å› å­ 0.75ã€‚put æ—¶é€šè¿‡ key çš„ hashCode è®¡ç®—æ•°ç»„ä¸‹æ ‡ï¼Œå¦‚æœå‘ç”Ÿå“ˆå¸Œå†²çªå°±ç”¨é“¾è¡¨ä¸²èµ·æ¥ã€‚å½“é“¾è¡¨é•¿åº¦è¾¾åˆ° 8 ä¸”æ•°ç»„é•¿åº¦è¾¾åˆ° 64 æ—¶ï¼Œé“¾è¡¨ä¼šè½¬æˆçº¢é»‘æ ‘ï¼ŒæŠŠæŸ¥æ‰¾æ—¶é—´ä» O(n) ä¼˜åŒ–åˆ° O(log n)ã€‚å½“çº¢é»‘æ ‘èŠ‚ç‚¹å‡å°‘åˆ° 6 ä¸ªæ—¶ä¼šé€€åŒ–å›é“¾è¡¨ã€‚"

---

### 4. HashMap çš„ put æµç¨‹ï¼Ÿ

> â­â­â­â­â­ å¿…è€ƒ | éš¾åº¦ï¼šâ­â­â­

**ä¸€å¥è¯å›ç­”**ï¼šè®¡ç®— key çš„å“ˆå¸Œå€¼å®šä½æ•°ç»„ä¸‹æ ‡ï¼Œå¦‚æœä¸ºç©ºç›´æ¥æ”¾å…¥ï¼Œä¸ä¸ºç©ºåˆ™åˆ¤æ–­ key æ˜¯å¦ç›¸åŒâ€”â€”ç›¸åŒå°±è¦†ç›–ï¼Œä¸åŒå°±æŒ‚åˆ°é“¾è¡¨æˆ–çº¢é»‘æ ‘ä¸Šï¼Œæœ€åæ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚

**é€šä¿—ç†è§£**ï¼š

ä½ å»å›¾ä¹¦é¦†è¿˜ä¹¦ï¼Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š
1. å…ˆçœ‹ä¹¦çš„åˆ†ç±»å·ï¼Œç¡®å®šæ”¾å“ªä¸ªä¹¦æ¶ï¼ˆ**è®¡ç®—å“ˆå¸Œå€¼ï¼Œå®šä½æ•°ç»„ä¸‹æ ‡**ï¼‰
2. èµ°åˆ°ä¹¦æ¶å‰ï¼Œå‘ç°æ¶å­æ˜¯ç©ºçš„ â†’ ç›´æ¥æ”¾ä¸Šå»ï¼ˆ**æ¡¶ä¸ºç©ºï¼Œç›´æ¥æ’å…¥**ï¼‰
3. æ¶å­ä¸Šæœ‰ä¹¦ â†’ çœ‹çœ‹æ˜¯ä¸æ˜¯åŒä¸€æœ¬ä¹¦çš„æ–°ç‰ˆæœ¬ï¼ˆ**key ç›¸åŒï¼Œè¦†ç›–æ—§å€¼**ï¼‰
4. ä¸æ˜¯åŒä¸€æœ¬ â†’ åœ¨è¿™ä¸ªæ¶å­ä¸Šå¾€åæ’ï¼ˆ**æŒ‚åˆ°é“¾è¡¨å°¾éƒ¨æˆ–æ’å…¥çº¢é»‘æ ‘**ï¼‰
5. è¿˜å®Œä¹¦åï¼Œç®¡ç†å‘˜æ£€æŸ¥å›¾ä¹¦é¦†æ˜¯ä¸æ˜¯å¤ªæ»¡äº†ï¼Œæ»¡äº†å°±æ¬åˆ°æ›´å¤§çš„é¦†ï¼ˆ**æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹**ï¼‰

**å›åˆ°æŠ€æœ¯**ï¼š"åˆ†ç±»å·"å°±æ˜¯ key çš„ hash å€¼å¯¹æ•°ç»„é•¿åº¦å–æ¨¡ã€‚"åŒä¸€æœ¬ä¹¦"å°±æ˜¯ key çš„ `equals()` è¿”å› trueã€‚"å¾€åæ’"åœ¨ JDK 8 ä¸­æ˜¯**å°¾æ’æ³•**ï¼ˆJDK 7 æ˜¯å¤´æ’æ³•ï¼Œå¤šçº¿ç¨‹ä¸‹ä¼šå¯¼è‡´æ­»å¾ªç¯ï¼‰ã€‚

**åŸç†è¯¦è§£**ï¼š

```
HashMap.put(key, value) å®Œæ•´æµç¨‹

â‘  hash = hash(key)  // æ‰°åŠ¨å‡½æ•°ï¼šhashCode é«˜16ä½å¼‚æˆ–ä½16ä½
        â†“
â‘¡ table ä¸ºç©ºï¼Ÿâ”€â”€æ˜¯â”€â”€â†’ resize() åˆå§‹åŒ–æ•°ç»„
        â†“ å¦
â‘¢ table[i] ä¸ºç©ºï¼Ÿâ”€â”€æ˜¯â”€â”€â†’ ç›´æ¥æ”¾å…¥æ–°èŠ‚ç‚¹
        â†“ å¦
â‘£ table[i].key == keyï¼Ÿâ”€â”€æ˜¯â”€â”€â†’ è¦†ç›–æ—§å€¼ï¼Œè¿”å›æ—§ value
        â†“ å¦
â‘¤ èŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘ï¼Ÿâ”€â”€æ˜¯â”€â”€â†’ è°ƒç”¨æ ‘çš„æ’å…¥æ–¹æ³•
        â†“ å¦
â‘¥ éå†é“¾è¡¨ï¼š
   - æ‰¾åˆ°ç›¸åŒ key â†’ è¦†ç›–
   - åˆ°è¾¾å°¾éƒ¨ â†’ å°¾æ’æ–°èŠ‚ç‚¹
   - æ’å…¥åé“¾è¡¨é•¿åº¦ â‰¥ 8 â†’ treeifyBin()ï¼ˆæ•°ç»„ â‰¥ 64 æ‰çœŸæ­£æ ‘åŒ–ï¼‰
        â†“
â‘¦ ++size > thresholdï¼Ÿâ”€â”€æ˜¯â”€â”€â†’ resize() æ‰©å®¹
```

**æ‰°åŠ¨å‡½æ•°**â€”â€”é¢è¯•å¸¸è¿½é—®"ä¸ºä»€ä¹ˆè¦é«˜ä½ä½å¼‚æˆ–"ï¼š

```java
// JDK 8 çš„ hash() æ–¹æ³•
static final int hash(Object key) {
    int h;
    // key ä¸º null æ”¾åœ¨ä¸‹æ ‡ 0 çš„ä½ç½®
    // å¦åˆ™ï¼šhashCode çš„é«˜ 16 ä½å’Œä½ 16 ä½åšå¼‚æˆ–
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

> ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿå› ä¸ºæ•°ç»„é•¿åº¦é€šå¸¸ä¸å¤§ï¼ˆæ¯”å¦‚ 16ï¼‰ï¼Œå–æ¨¡æ—¶åªç”¨åˆ°äº† hashCode çš„ä½å‡ ä½ï¼Œé«˜ä½ä¿¡æ¯è¢«æµªè´¹äº†ã€‚é«˜ä½ä½å¼‚æˆ–è®©é«˜ä½ä¹Ÿå‚ä¸è¿ç®—ï¼Œ**å‡å°‘å“ˆå¸Œå†²çª**ã€‚

**ğŸ¤ é¢è¯•è¿™æ ·ç­”**ï¼š
> "HashMap çš„ put æµç¨‹ï¼šé¦–å…ˆå¯¹ key åš hash æ‰°åŠ¨ï¼Œé«˜ 16 ä½å¼‚æˆ–ä½ 16 ä½å‡å°‘å†²çªã€‚ç„¶åç”¨ hash & (n-1) å®šä½æ•°ç»„ä¸‹æ ‡ã€‚å¦‚æœæ¡¶ä¸ºç©ºç›´æ¥æ’å…¥ï¼›ä¸ä¸ºç©ºå°±åˆ¤æ–­ key æ˜¯å¦ç›¸åŒï¼Œç›¸åŒåˆ™è¦†ç›–ã€‚ä¸åŒçš„è¯ï¼Œå¦‚æœæ˜¯çº¢é»‘æ ‘å°±èµ°æ ‘çš„æ’å…¥ï¼Œå¦åˆ™éå†é“¾è¡¨å°¾æ’ã€‚æ’å…¥åå¦‚æœé“¾è¡¨é•¿åº¦è¾¾åˆ° 8 ä¸”æ•°ç»„é•¿åº¦è¾¾åˆ° 64 å°±æ ‘åŒ–ã€‚æœ€ååˆ¤æ–­å…ƒç´ æ€»æ•°æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Œè¶…è¿‡å°±æ‰©å®¹ã€‚JDK 8 æ”¹ç”¨å°¾æ’æ³•ï¼Œè§£å†³äº† JDK 7 å¤´æ’æ³•åœ¨å¤šçº¿ç¨‹ä¸‹çš„æ­»å¾ªç¯é—®é¢˜ã€‚"

---

### 5. HashMap çš„æ‰©å®¹æœºåˆ¶ï¼Ÿ

> â­â­â­â­â­ å¿…è€ƒ | éš¾åº¦ï¼šâ­â­â­â­

**ä¸€å¥è¯å›ç­”**ï¼šå½“å…ƒç´ ä¸ªæ•°è¶…è¿‡ å®¹é‡ Ã— è´Ÿè½½å› å­ æ—¶ï¼Œæ•°ç»„æ‰©å¤§ä¸ºåŸæ¥çš„ âš¡**2 å€**ï¼Œæ‰€æœ‰å…ƒç´ é‡æ–°è®¡ç®—ä½ç½®ã€‚

**é€šä¿—ç†è§£**ï¼š

è¿˜æ˜¯å¿«é€’æŸœçš„ä¾‹å­ã€‚ä¸€å¼€å§‹æœ‰ 16 ä¸ªæ ¼å­ï¼Œæ¯ä¸ªæ ¼å­æœ€å¤šæŒ‚å‡ ä¸ªå¿«é€’ã€‚å½“å¿«é€’æ€»æ•°è¶…è¿‡ 12 ä¸ªï¼ˆ16 Ã— 0.75ï¼‰æ—¶ï¼Œå¿«é€’æŸœå¤ªæŒ¤äº†ï¼Œæ¢ä¸€ä¸ª 32 æ ¼çš„æ–°æŸœå­ï¼Œç„¶åæŠŠæ‰€æœ‰å¿«é€’æŒ‰æ–°çš„ç¼–å·è§„åˆ™é‡æ–°åˆ†é…åˆ°æ–°æ ¼å­é‡Œã€‚

**å›åˆ°æŠ€æœ¯**ï¼š"æ¢æ–°æŸœå­"å°±æ˜¯åˆ›å»ºä¸€ä¸ª 2 å€å¤§å°çš„æ–°æ•°ç»„ã€‚"é‡æ–°åˆ†é…"å°±æ˜¯ **rehashï¼ˆé‡æ–°å“ˆå¸Œï¼‰**â€”â€”æ¯ä¸ªå…ƒç´ è¦é‡æ–°è®¡ç®—åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®ã€‚

**åŸç†è¯¦è§£**ï¼š

**æ‰©å®¹è§¦å‘æ¡ä»¶**ï¼š`size > capacity Ã— loadFactor`ï¼ˆé»˜è®¤å°±æ˜¯ `size > 16 Ã— 0.75 = 12`ï¼‰

**JDK 8 çš„å·§å¦™ä¼˜åŒ–**â€”â€”ä¸éœ€è¦é‡æ–°ç®— hashï¼š

æ‰©å®¹åæ•°ç»„é•¿åº¦ç¿»å€ï¼ˆæ¯”å¦‚ 16 â†’ 32ï¼‰ï¼Œæ¯ä¸ªå…ƒç´ åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®åªæœ‰ä¸¤ç§å¯èƒ½ï¼š
- **åŸä½ç½®**ï¼ˆä¸‹æ ‡ä¸å˜ï¼‰
- **åŸä½ç½® + æ—§å®¹é‡**ï¼ˆæ¯”å¦‚åŸæ¥åœ¨ä¸‹æ ‡ 5ï¼Œæ‰©å®¹åè¦ä¹ˆè¿˜åœ¨ 5ï¼Œè¦ä¹ˆåœ¨ 5 + 16 = 21ï¼‰

æ€ä¹ˆåˆ¤æ–­ï¼Ÿåªéœ€è¦çœ‹ hash å€¼æ–°å¢çš„é‚£ä¸€ä½æ˜¯ 0 è¿˜æ˜¯ 1ï¼š

```
æ—§å®¹é‡ 16 = 0001 0000ï¼Œæ‰©å®¹å 32 = 0010 0000

hash å€¼:  xxxx xxxx xxxx xxxx
                          â†‘ çœ‹è¿™ä¸€ä½ï¼ˆç¬¬ 5 ä½ï¼‰
                          0 â†’ ç•™åœ¨åŸä½ç½®
                          1 â†’ åŸä½ç½® + 16
```

> è¿™ä¸ªè®¾è®¡éå¸¸å·§å¦™ï¼šä¸éœ€è¦åƒ JDK 7 é‚£æ ·é‡æ–°è®¡ç®—æ¯ä¸ªå…ƒç´ çš„ hashï¼Œåªéœ€è¦çœ‹ä¸€ä¸ª bit ä½ï¼Œâš¡**ç”¨ä½è¿ç®—ä»£æ›¿å–æ¨¡**ï¼Œæ•ˆç‡æé«˜ã€‚è€Œä¸”æ‰©å®¹åé“¾è¡¨çš„é¡ºåºä¸ä¼šåè½¬ï¼Œé¿å…äº† JDK 7 ä¸­å¤šçº¿ç¨‹æ‰©å®¹å¯¼è‡´çš„é“¾è¡¨æ­»å¾ªç¯ã€‚

**ğŸ¤ é¢è¯•è¿™æ ·ç­”**ï¼š
> "HashMap åœ¨å…ƒç´ ä¸ªæ•°è¶…è¿‡å®¹é‡ä¹˜ä»¥è´Ÿè½½å› å­æ—¶æ‰©å®¹ï¼Œæ–°å®¹é‡æ˜¯æ—§å®¹é‡çš„ 2 å€ã€‚JDK 8 çš„æ‰©å®¹åšäº†ä¼˜åŒ–ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®— hashï¼Œåªéœ€è¦çœ‹ hash å€¼æ–°å¢çš„é‚£ä¸€ä½æ˜¯ 0 è¿˜æ˜¯ 1ï¼Œå°±èƒ½åˆ¤æ–­å…ƒç´ åœ¨æ–°æ•°ç»„ä¸­æ˜¯ç•™åœ¨åŸä½è¿˜æ˜¯ç§»åˆ°åŸä½ç½®åŠ æ—§å®¹é‡çš„ä½ç½®ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ HashMap çš„å®¹é‡å¿…é¡»æ˜¯ 2 çš„å¹‚â€”â€”è¿™æ ·æ‰èƒ½ç”¨ä½è¿ç®—ä»£æ›¿å–æ¨¡ï¼ŒåŒæ—¶è®©æ‰©å®¹æ—¶çš„å…ƒç´ è¿ç§»æ›´é«˜æ•ˆã€‚"

---

### 6. HashMap ä¸ºä»€ä¹ˆçº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ

> â­â­â­â­ é«˜é¢‘ | éš¾åº¦ï¼šâ­â­â­

**ä¸€å¥è¯å›ç­”**ï¼šHashMap çš„ put å’Œæ‰©å®¹æ“ä½œæ²¡æœ‰åŠ é”ï¼Œå¤šçº¿ç¨‹å¹¶å‘æ—¶ä¼šå¯¼è‡´æ•°æ®è¦†ç›–ä¸¢å¤±ï¼ŒJDK 7 ä¸­è¿˜ä¼šå‡ºç°é“¾è¡¨æ­»å¾ªç¯ã€‚

**é€šä¿—ç†è§£**ï¼š

ä¸¤ä¸ªäººåŒæ—¶å¾€åŒä¸€ä¸ªæ ¼å­é‡Œæ”¾å¿«é€’ï¼Œä¸€ä¸ªäººæ”¾çš„æ—¶å€™å¦ä¸€ä¸ªäººä¹Ÿåœ¨æ”¾ï¼Œç»“æœä¸€ä¸ªäººçš„å¿«é€’è¢«å¦ä¸€ä¸ªäººçš„ç›–ä½äº†â€”â€”å¿«é€’ä¸¢äº†ã€‚

**å›åˆ°æŠ€æœ¯**ï¼šHashMap çš„æ‰€æœ‰æ“ä½œéƒ½æ²¡æœ‰åŒæ­¥æœºåˆ¶ï¼Œå¤šçº¿ç¨‹å¹¶å‘æ—¶ä¸»è¦æœ‰ä»¥ä¸‹é—®é¢˜ï¼š

**â‘  JDK 8ï¼šæ•°æ®è¦†ç›–**

ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ putï¼Œhash åˆ°åŒä¸€ä¸ªæ¡¶ï¼Œéƒ½åˆ¤æ–­æ¡¶ä¸ºç©ºï¼Œç„¶åå„è‡ªæ’å…¥â€”â€”åæ’å…¥çš„è¦†ç›–å…ˆæ’å…¥çš„ï¼Œ**æ•°æ®ä¸¢å¤±**ã€‚

```java
// ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œåˆ°è¿™ä¸€è¡Œï¼Œéƒ½å‘ç° table[i] == null
if ((p = tab[i = (n - 1) & hash]) == null)
    tab[i] = newNode(hash, key, value, null);
// çº¿ç¨‹ A å†™å…¥åï¼Œçº¿ç¨‹ B ç´§æ¥ç€å†™å…¥ï¼ŒA çš„æ•°æ®è¢«è¦†ç›–
```

**â‘¡ JDK 7ï¼šé“¾è¡¨æ­»å¾ªç¯ï¼ˆç»å…¸é¢è¯•é¢˜ï¼‰**

JDK 7 æ‰©å®¹æ—¶ç”¨**å¤´æ’æ³•**è¿ç§»é“¾è¡¨ï¼Œå¤šçº¿ç¨‹åŒæ—¶æ‰©å®¹ä¼šå¯¼è‡´é“¾è¡¨å½¢æˆç¯ï¼Œä¹‹å `get()` æ“ä½œä¼šé™·å…¥æ­»å¾ªç¯ï¼ŒCPU é£™åˆ° 100%ã€‚

> JDK 8 æ”¹ç”¨**å°¾æ’æ³•**ï¼Œè§£å†³äº†æ­»å¾ªç¯é—®é¢˜ï¼Œä½†æ•°æ®è¦†ç›–é—®é¢˜ä¾ç„¶å­˜åœ¨ã€‚æ‰€ä»¥å¤šçº¿ç¨‹åœºæ™¯å¿…é¡»ç”¨ `ConcurrentHashMap`ã€‚

**ğŸ¤ é¢è¯•è¿™æ ·ç­”**ï¼š
> "HashMap çº¿ç¨‹ä¸å®‰å…¨ä¸»è¦ä½“ç°åœ¨ä¸¤æ–¹é¢ã€‚JDK 7 ä¸­æ‰©å®¹ç”¨å¤´æ’æ³•ï¼Œå¤šçº¿ç¨‹å¹¶å‘æ‰©å®¹ä¼šå¯¼è‡´é“¾è¡¨æˆç¯ï¼Œget æ—¶æ­»å¾ªç¯ã€‚JDK 8 æ”¹æˆäº†å°¾æ’æ³•è§£å†³äº†æ­»å¾ªç¯ï¼Œä½†å¤šçº¿ç¨‹åŒæ—¶ put ä»ç„¶ä¼šå‡ºç°æ•°æ®è¦†ç›–ä¸¢å¤±çš„é—®é¢˜ï¼Œå› ä¸º put æ“ä½œæ²¡æœ‰ä»»ä½•åŒæ­¥æªæ–½ã€‚å¤šçº¿ç¨‹åœºæ™¯åº”è¯¥ç”¨ ConcurrentHashMapã€‚"

---

### 7. ConcurrentHashMap å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ

> â­â­â­â­â­ å¿…è€ƒ | éš¾åº¦ï¼šâ­â­â­â­

**ä¸€å¥è¯å›ç­”**ï¼šJDK 7 ç”¨åˆ†æ®µé”ï¼ˆSegmentï¼‰ï¼ŒJDK 8 æ”¹ä¸º CAS + synchronized é”å•ä¸ªæ¡¶ï¼Œç²’åº¦æ›´ç»†ã€å¹¶å‘åº¦æ›´é«˜ã€‚

**é€šä¿—ç†è§£**ï¼š

è¿˜æ˜¯å¿«é€’æŸœçš„åœºæ™¯ï¼Œç°åœ¨è¦è§£å†³"ä¸¤ä¸ªäººåŒæ—¶æ”¾å¿«é€’å¯¼è‡´ä¸¢ä»¶"çš„é—®é¢˜ï¼š
- **JDK 7 çš„æ–¹æ¡ˆ**ï¼ˆåˆ†æ®µé”ï¼‰= æŠŠå¿«é€’æŸœåˆ†æˆ âš¡**16 æ®µ**ï¼Œæ¯æ®µæœ‰ä¸€æŠŠé”ã€‚ä½ æ”¾ç¬¬ 3 æ®µçš„å¿«é€’æ—¶ï¼Œåˆ«äººè¿˜èƒ½åŒæ—¶æ”¾ç¬¬ 7 æ®µçš„ï¼Œäº’ä¸å½±å“ã€‚ä½†åŒä¸€æ®µå†…åªèƒ½ä¸€ä¸ªäººæ“ä½œ
- **JDK 8 çš„æ–¹æ¡ˆ**ï¼ˆCAS + synchronizedï¼‰= ä¸åˆ†æ®µäº†ï¼Œç›´æ¥é”å•ä¸ªæ ¼å­ã€‚ä½ æ”¾ç¬¬ 3 æ ¼æ—¶ï¼Œåªé”ç¬¬ 3 æ ¼ï¼Œå…¶ä»–æ‰€æœ‰æ ¼å­éƒ½èƒ½åŒæ—¶æ“ä½œã€‚ç²’åº¦ä»"ä¸€æ®µ"ç»†åŒ–åˆ°"ä¸€æ ¼"

**å›åˆ°æŠ€æœ¯**ï¼š"ä¸€æ®µ"å°±æ˜¯ JDK 7 çš„ **Segmentï¼ˆåˆ†æ®µï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªå°çš„ HashMapï¼‰**ï¼Œé»˜è®¤ 16 ä¸ª Segmentï¼Œå¹¶å‘åº¦å°±æ˜¯ 16ã€‚"ä¸€æ ¼"å°±æ˜¯ JDK 8 ä¸­æ•°ç»„çš„ä¸€ä¸ªæ¡¶ï¼ˆNodeï¼‰ï¼Œç”¨ **synchronized é”ä½é“¾è¡¨/çº¢é»‘æ ‘çš„å¤´èŠ‚ç‚¹**ï¼Œåªè¦ä¸æ˜¯åŒä¸€ä¸ªæ¡¶ï¼Œå°±èƒ½å®Œå…¨å¹¶è¡Œã€‚

**åŸç†è¯¦è§£**ï¼š

**JDK 7ï¼šSegment åˆ†æ®µé”**

```
ConcurrentHashMapï¼ˆJDK 7ï¼‰

Segment[] æ•°ç»„ï¼ˆé»˜è®¤ 16 ä¸ªæ®µï¼Œæ¯æ®µä¸€æŠŠ ReentrantLockï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Segment0 â”‚ Segment1 â”‚ Segment2 â”‚   ...    â”‚
â”‚  ğŸ”’é”     â”‚  ğŸ”’é”     â”‚  ğŸ”’é”     â”‚          â”‚
â”‚ â”Œâ”€â”€â”¬â”€â”€â”  â”‚ â”Œâ”€â”€â”¬â”€â”€â”  â”‚ â”Œâ”€â”€â”¬â”€â”€â”  â”‚          â”‚
â”‚ â”‚  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚  â”‚          â”‚
â”‚ â””â”€â”€â”´â”€â”€â”˜  â”‚ â””â”€â”€â”´â”€â”€â”˜  â”‚ â””â”€â”€â”´â”€â”€â”˜  â”‚          â”‚
â”‚ å°HashMap â”‚ å°HashMap â”‚ å°HashMap â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- æ¯ä¸ª Segment ç»§æ‰¿ `ReentrantLock`ï¼Œè‡ªå¸¦é”åŠŸèƒ½
- put æ—¶å…ˆå®šä½åˆ° Segmentï¼Œå†é”ä½è¿™ä¸ª Segment æ“ä½œ
- ç¼ºç‚¹ï¼šå¹¶å‘åº¦å›ºå®šä¸º âš¡**16**ï¼Œåˆå§‹åŒ–åä¸èƒ½æ”¹ï¼›æ•°æ®ç»“æ„æ˜¯æ•°ç»„ + é“¾è¡¨ï¼Œæ²¡æœ‰çº¢é»‘æ ‘

**JDK 8ï¼šCAS + synchronizedï¼ˆé‡ç‚¹æŒæ¡ï¼‰**

```java
// JDK 8 çš„ put æ ¸å¿ƒé€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
final V putVal(K key, V value) {
    // â‘  è®¡ç®— hash
    int hash = spread(key.hashCode());
    for (Node<K,V>[] tab = table;;) {
        Node<K,V> f;
        // â‘¡ æ¡¶ä¸ºç©º â†’ ç”¨ CAS æ— é”æ’å…¥
        if ((f = tab[i]) == null) {
            if (casTabAt(tab, i, null, new Node<>(hash, key, value)))
                break;  // CAS æˆåŠŸï¼Œæ’å…¥å®Œæ¯•
        }
        // â‘¢ æ¡¶ä¸ä¸ºç©º â†’ synchronized é”ä½å¤´èŠ‚ç‚¹
        else {
            synchronized (f) {
                // é“¾è¡¨æˆ–çº¢é»‘æ ‘çš„æ’å…¥é€»è¾‘ï¼ˆå’Œ HashMap ç±»ä¼¼ï¼‰
            }
        }
    }
    // â‘£ ç”¨ addCount() ç»Ÿè®¡å…ƒç´ ä¸ªæ•°ï¼ˆä¹Ÿæ˜¯ CASï¼‰
}
```

| å¯¹æ¯” | JDK 7 | JDK 8 |
|------|-------|-------|
| é”çš„ç²’åº¦ | é”ä¸€ä¸ª Segmentï¼ˆä¸€æ®µï¼‰ | é”ä¸€ä¸ªæ¡¶çš„å¤´èŠ‚ç‚¹ï¼ˆä¸€æ ¼ï¼‰ |
| é”çš„å®ç° | `ReentrantLock` | `synchronized`ï¼ˆJDK 8 ä¼˜åŒ–åæ€§èƒ½ä¸è¾“ ReentrantLockï¼‰ |
| æ•°æ®ç»“æ„ | æ•°ç»„ + é“¾è¡¨ | æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ |
| å¹¶å‘åº¦ | å›ºå®š âš¡**16** | ç­‰äºæ•°ç»„é•¿åº¦ï¼Œ**åŠ¨æ€æ‰©å±•** |

**ğŸ¤ é¢è¯•è¿™æ ·ç­”**ï¼š
> "ConcurrentHashMap åœ¨ JDK 7 ä¸­ç”¨åˆ†æ®µé”å®ç°ï¼ŒæŠŠæ•°æ®åˆ†æˆ 16 ä¸ª Segmentï¼Œæ¯ä¸ª Segment ä¸€æŠŠ ReentrantLockï¼Œä¸åŒæ®µä¹‹é—´å¯ä»¥å¹¶å‘æ“ä½œã€‚JDK 8 åšäº†é‡å¤§æ”¹è¿›ï¼ŒåºŸå¼ƒäº†åˆ†æ®µé”ï¼Œæ”¹ç”¨ CAS åŠ  synchronizedã€‚put æ—¶å¦‚æœæ¡¶ä¸ºç©ºå°±ç”¨ CAS æ— é”æ’å…¥ï¼Œæ¡¶ä¸ä¸ºç©ºå°±ç”¨ synchronized é”ä½å¤´èŠ‚ç‚¹å†æ“ä½œã€‚é”ç²’åº¦ä»æ®µçº§åˆ«ç»†åŒ–åˆ°æ¡¶çº§åˆ«ï¼Œå¹¶å‘åº¦ç­‰äºæ•°ç»„é•¿åº¦ï¼Œè€Œä¸”å¼•å…¥äº†çº¢é»‘æ ‘ä¼˜åŒ–é•¿é“¾è¡¨çš„æŸ¥è¯¢æ€§èƒ½ã€‚"

---

### 8. HashMap å’Œ Hashtable çš„åŒºåˆ«ï¼Ÿ

> â­â­â­ å¸¸é—® | éš¾åº¦ï¼šâ­â­

**å›ç­”**ï¼šç®€å•è¯´ï¼ŒHashtable æ˜¯"ä¸Šå¤æ—¶ä»£"çš„çº¿ç¨‹å®‰å…¨ Mapï¼Œç”¨ synchronized é”æ•´ä¸ªè¡¨ï¼Œæ€§èƒ½å¾ˆå·®ã€‚ç°åœ¨åŸºæœ¬æ²¡äººç”¨äº†ï¼Œå¤šçº¿ç¨‹åœºæ™¯ç›´æ¥ç”¨ ConcurrentHashMapã€‚

| å¯¹æ¯”é¡¹ | HashMap | Hashtable |
|--------|---------|-----------|
| çº¿ç¨‹å®‰å…¨ | âŒ ä¸å®‰å…¨ | âœ… å®‰å…¨ï¼ˆsynchronized é”æ•´ä¸ªæ–¹æ³•ï¼‰ |
| æ€§èƒ½ | å¿« | âš¡**æ…¢å¾ˆå¤š**ï¼Œæ¯æ¬¡æ“ä½œéƒ½è¦è·å–é” |
| null å€¼ | key å’Œ value éƒ½âš¡**å…è®¸ null** | key å’Œ value éƒ½âš¡**ä¸å…è®¸ null** |
| åˆå§‹å®¹é‡ | âš¡**16** | âš¡**11** |
| æ‰©å®¹æ–¹å¼ | 2 å€ | 2 å€ + 1 |
| ç»§æ‰¿å…³ç³» | ç»§æ‰¿ AbstractMap | ç»§æ‰¿ Dictionaryï¼ˆå·²è¿‡æ—¶ï¼‰ |

> **é¢è¯•è¿½é—®**ï¼šä¸ºä»€ä¹ˆ ConcurrentHashMap ä¹Ÿä¸å…è®¸ null key/valueï¼Ÿå› ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ`get(key)` è¿”å› null æ—¶æ— æ³•åŒºåˆ†æ˜¯"key ä¸å­˜åœ¨"è¿˜æ˜¯"value å°±æ˜¯ null"ï¼Œä¼šäº§ç”ŸäºŒä¹‰æ€§ã€‚HashMap å•çº¿ç¨‹ä¸‹å¯ä»¥ç”¨ `containsKey()` å†åˆ¤æ–­ä¸€æ¬¡ï¼Œä½†å¹¶å‘ç¯å¢ƒä¸‹ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´çŠ¶æ€å¯èƒ½å·²ç»å˜äº†ã€‚

---

## ä¸‰ã€Set & é€šç”¨

### 9. HashSet çš„å®ç°åŸç†ï¼Ÿ

> â­â­â­ å¸¸é—® | éš¾åº¦ï¼šâ­â­

**å›ç­”**ï¼šHashSet åº•å±‚å°±æ˜¯ä¸€ä¸ª HashMapï¼Œå…ƒç´ å­˜åœ¨ HashMap çš„ key é‡Œï¼Œvalue ç»Ÿä¸€ç”¨ä¸€ä¸ªå›ºå®šçš„ç©ºå¯¹è±¡å ä½ã€‚ä½ å¯ä»¥ç†è§£ä¸º HashSet å°±æ˜¯"åªç”¨äº† key çš„ HashMap"ã€‚

```java
// HashSet æºç ï¼ˆæåº¦ç®€åŒ–ï¼‰
public class HashSet<E> {
    private transient HashMap<E, Object> map;

    // æ‰€æœ‰ value éƒ½æŒ‡å‘åŒä¸€ä¸ªç©ºå¯¹è±¡ï¼Œçº¯å ä½ç”¨
    private static final Object PRESENT = new Object();

    public boolean add(E e) {
        return map.put(e, PRESENT) == null; // åˆ©ç”¨ HashMap çš„ key ä¸é‡å¤ç‰¹æ€§
    }

    public boolean contains(Object o) {
        return map.containsKey(o); // ç›´æ¥æŸ¥ HashMap çš„ key
    }
}
```

> æ‰€ä»¥ HashSet çš„å»é‡åŸç†å’Œ HashMap åˆ¤æ–­ key ç›¸åŒçš„é€»è¾‘ä¸€æ ·ï¼šå…ˆæ¯” `hashCode()`ï¼Œå†æ¯” `equals()`ã€‚è‡ªå®šä¹‰å¯¹è±¡æ”¾è¿› HashSet æ—¶ï¼Œå¿…é¡»åŒæ—¶é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚

---

### 10. fail-fast å’Œ fail-safe æœºåˆ¶ï¼Ÿ

> â­â­ äº†è§£ | éš¾åº¦ï¼šâ­â­

**å›ç­”**ï¼šç®€å•è¯´ï¼Œfail-fast æ˜¯"ä¸€å‘ç°æœ‰äººå·å·æ”¹äº†é›†åˆå°±ç«‹åˆ»æŠ¥é”™"ï¼Œfail-safe æ˜¯"æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘æ“ä½œçš„æ˜¯å‰¯æœ¬"ã€‚

| å¯¹æ¯”é¡¹ | fail-fastï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰ | fail-safeï¼ˆå®‰å…¨å¤±è´¥ï¼‰ |
|--------|----------------------|----------------------|
| ä»£è¡¨é›†åˆ | `ArrayList`ã€`HashMap` | `CopyOnWriteArrayList`ã€`ConcurrentHashMap` |
| éå†æ—¶ä¿®æ”¹ | æŠ› âš¡`ConcurrentModificationException` | ä¸æŠ¥é”™ï¼Œä½†å¯èƒ½è¯»ä¸åˆ°æœ€æ–°æ•°æ® |
| åŸç† | å†…éƒ¨ç»´æŠ¤ `modCount`ï¼Œéå†æ—¶å‘ç°è¢«æ”¹äº†å°±æŠ›å¼‚å¸¸ | æ“ä½œçš„æ˜¯æ•°æ®çš„å¿«ç…§æˆ–å‰¯æœ¬ |
| é€‚ç”¨åœºæ™¯ | å•çº¿ç¨‹ï¼ŒåŠæ—¶å‘ç° bug | å¤šçº¿ç¨‹å¹¶å‘è¯»å†™ |

```java
// fail-fast ç¤ºä¾‹ï¼šéå† ArrayList æ—¶åˆ é™¤å…ƒç´ ä¼šæŠ¥é”™
List<String> list = new ArrayList<>(Arrays.asList("a", "b", "c"));
for (String s : list) {
    if ("b".equals(s)) {
        list.remove(s); // ğŸ’¥ ConcurrentModificationException
    }
}

// æ­£ç¡®åšæ³•ï¼šç”¨ Iterator çš„ remove æ–¹æ³•
Iterator<String> it = list.iterator();
while (it.hasNext()) {
    if ("b".equals(it.next())) {
        it.remove(); // âœ… å®‰å…¨åˆ é™¤
    }
}
```

---

## é¢è¯•é«˜é¢‘ç¨‹åº¦æ’åºï¼ˆ3~5 å¹´ï¼‰

| ä¼˜å…ˆçº§ | é¢˜ç›® |
|--------|------|
| â­â­â­â­â­ | HashMap çš„åº•å±‚æ•°æ®ç»“æ„ï¼Ÿ |
| â­â­â­â­â­ | HashMap çš„ put æµç¨‹ï¼Ÿ |
| â­â­â­â­â­ | HashMap çš„æ‰©å®¹æœºåˆ¶ï¼Ÿ |
| â­â­â­â­â­ | ConcurrentHashMap å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ |
| â­â­â­â­ | ArrayList å’Œ LinkedList çš„åŒºåˆ«ï¼Ÿ |
| â­â­â­â­ | HashMap ä¸ºä»€ä¹ˆçº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ |
| â­â­â­ | ArrayList çš„æ‰©å®¹æœºåˆ¶ï¼Ÿ |
| â­â­â­ | HashMap å’Œ Hashtable çš„åŒºåˆ«ï¼Ÿ |
| â­â­â­ | HashSet çš„å®ç°åŸç†ï¼Ÿ |
| â­â­ | fail-fast å’Œ fail-safe æœºåˆ¶ï¼Ÿ |
