# 15 - 微服务

> 覆盖微服务架构核心知识：Spring Cloud 核心组件、服务注册与发现、网关、熔断降级、服务通信等高频面试考点。熔断降级和注册中心是面试重灾区。

---

## 一、基础

### 1. 什么是微服务？和单体架构的区别？

> ⭐⭐⭐⭐⭐ 必考 | 难度：⭐⭐

**一句话回答**：微服务是把一个大应用拆成多个小服务，每个服务独立部署、独立数据库、通过网络通信。

**通俗理解**：

- **单体架构** = 一家什么都卖的大超市，所有商品挤在一栋楼里。生意好了想扩建，只能把整栋楼推倒重建
- **微服务** = 一条商业街，水果店、面包店、奶茶店各自独立经营。水果店生意好就单独扩一家分店，不影响其他店

**回到技术**："各自独立经营"就是每个微服务有自己的代码仓库、数据库、部署流程。"单独扩分店"就是可以针对高流量的服务单独扩容，不需要整体扩容。

| 对比项 | 单体架构 | 微服务架构 |
|--------|---------|-----------|
| 部署 | 整体打包部署 | ⚡**每个服务独立部署** |
| 扩展 | 整体扩容 | 按需扩容某个服务 |
| 技术栈 | 统一 | 每个服务可以用不同技术栈 |
| 复杂度 | 代码耦合，后期维护难 | 服务拆分清晰，但⚡**运维复杂度高** |
| 适用场景 | 小项目、初创团队 | 中大型项目、团队规模大 |

> **微服务不是银弹**：拆成微服务后会引入服务通信、分布式事务、服务治理等一系列复杂问题。小项目用单体就够了，不要为了微服务而微服务。

**🎤 面试这样答**：
> "微服务是把单体应用按业务边界拆分成多个独立服务，每个服务独立开发、部署和扩展。优点是服务解耦、可以按需扩容、技术栈灵活。缺点是引入了服务通信、分布式事务、运维复杂度等问题。适合中大型项目和多团队协作的场景。"

---

### 2. Spring Cloud 有哪些核心组件？

> ⭐⭐⭐⭐⭐ 必考 | 难度：⭐⭐⭐

**一句话回答**：Spring Cloud 是微服务的一站式解决方案，核心组件覆盖注册中心、网关、远程调用、熔断降级、配置中心五大能力。

**通俗理解**：

把微服务架构想象成一座城市的交通系统：
- **注册中心（Nacos）** = 交通管理局，记录所有公交线路（服务）的信息，你要坐车先查它
- **网关（Gateway）** = 城市大门口的收费站，所有车辆（请求）都从这里进出，统一检查和分流
- **远程调用（Feign）** = 打电话叫外卖，你只需要说"我要一份炒饭"，不用关心外卖怎么送来的
- **熔断降级（Sentinel）** = 保险丝，某条路堵死了就自动绕路或暂时封路，防止整个城市瘫痪
- **配置中心（Nacos Config）** = 市政公告栏，统一发布通知，所有部门同步更新

**回到技术**：

| 能力 | Spring Cloud Netflix（旧） | Spring Cloud Alibaba（主流） |
|------|--------------------------|----------------------------|
| 注册中心 | Eureka（已停更） | ⚡**Nacos** |
| 网关 | Zuul | ⚡**Spring Cloud Gateway** |
| 远程调用 | Feign | ⚡**OpenFeign** |
| 熔断降级 | Hystrix（已停更） | ⚡**Sentinel** |
| 配置中心 | Spring Cloud Config | ⚡**Nacos Config** |
| 负载均衡 | Ribbon | ⚡**LoadBalancer** |

> **现在主流技术栈**：Spring Cloud Alibaba（Nacos + Sentinel + Gateway + OpenFeign），Netflix 那套基本已经淘汰了。

**🎤 面试这样答**：
> "Spring Cloud 的核心组件包括：Nacos 做注册中心和配置中心，Spring Cloud Gateway 做网关统一路由和鉴权，OpenFeign 做声明式远程调用，Sentinel 做熔断降级和限流，LoadBalancer 做负载均衡。目前主流用的是 Spring Cloud Alibaba 技术栈，Netflix 那套 Eureka、Hystrix 基本已经停更了。"

---

## 二、服务治理

### 3. 服务注册与发现的原理？Nacos 和 Eureka 的区别？

> ⭐⭐⭐⭐⭐ 必考 | 难度：⭐⭐⭐

**一句话回答**：服务启动时把自己的地址注册到注册中心，调用方从注册中心获取服务列表，实现动态发现。Nacos 同时支持 CP 和 AP，Eureka 只支持 AP。

**通俗理解**：

注册中心就像一个通讯录。每个人（服务）入职时把自己的电话号码登记到通讯录上，要找人（调用服务）时翻通讯录查号码，不用记住每个人的号码。有人离职了（服务下线），通讯录自动更新。

**回到技术**："登记电话"就是服务注册，"翻通讯录"就是服务发现，"自动更新"就是心跳检测——服务定期向注册中心发心跳，超时未发就认为下线。

```
服务注册与发现流程：

① 服务 A 启动 → 向注册中心注册自己的地址（IP:Port）
② 服务 A 定期发送心跳 → 注册中心确认 A 还活着
③ 服务 B 要调用 A → 从注册中心拉取 A 的地址列表
④ 服务 B 通过负载均衡选一个地址发起调用
⑤ 服务 A 宕机 → 心跳超时，注册中心剔除 A
```

| 对比项 | Nacos | Eureka |
|--------|-------|--------|
| 一致性模型 | ⚡**同时支持 CP 和 AP**（可切换） | 只支持 AP |
| 健康检查 | 服务端主动探测 + 客户端心跳 | 仅客户端心跳 |
| 配置中心 | ⚡**自带配置中心** | 不支持，需要额外组件 |
| 维护状态 | 阿里持续维护 | Netflix ⚡**已停更** |

> **Nacos 的 CP 和 AP 怎么切换？** 临时实例（默认）用 AP 模式，基于心跳检测；永久实例用 CP 模式，基于 Raft 协议保证数据一致性。

**🎤 面试这样答**：
> "服务注册与发现的原理是：服务启动时向注册中心注册地址，定期发心跳保活；调用方从注册中心拉取服务列表，通过负载均衡选择实例调用。Nacos 和 Eureka 的主要区别是：Nacos 同时支持 CP 和 AP 模式，自带配置中心，功能更全面；Eureka 只支持 AP，而且已经停更了。目前主流用 Nacos。"

---

### 4. 什么是熔断降级？Sentinel 怎么用？

> ⭐⭐⭐⭐⭐ 必考 | 难度：⭐⭐⭐

**一句话回答**：熔断是当下游服务故障时自动切断调用，防止故障扩散；降级是熔断后返回一个兜底响应，保证核心流程可用。Sentinel 是阿里开源的流量控制组件。

**通俗理解**：

- **熔断** = 家里的保险丝。某个电器短路了，保险丝自动断开，防止整栋楼跳闸。过一会儿试着合上保险丝，如果电器修好了就恢复供电
- **降级** = 保险丝断了之后，你用蜡烛照明（兜底方案），虽然没有电灯亮，但至少不是一片漆黑

**回到技术**："保险丝断开"就是熔断器从关闭状态变为打开状态，所有请求直接返回兜底结果，不再调用下游。"试着合上"就是半开状态，放一小部分请求试探下游是否恢复。

**熔断器的三种状态**：

```
关闭（正常）──失败率超过阈值──→ 打开（熔断）
                                    │
                              等待超时时间
                                    │
                                    ▼
                              半开（试探）
                              ├── 试探成功 → 回到关闭
                              └── 试探失败 → 回到打开
```

**Sentinel 的核心能力**：

| 能力 | 说明 |
|------|------|
| **流量控制** | 限制 QPS，超过阈值直接拒绝（⚡**限流**） |
| **熔断降级** | 慢调用比例或异常比例超过阈值，触发熔断 |
| **热点参数限流** | 针对某个热点参数（如商品 ID）单独限流 |
| **系统保护** | 根据系统负载（CPU、线程数）自适应限流 |

```java
// Sentinel 熔断降级示例（注解方式）
@SentinelResource(value = "getUser", fallback = "getUserFallback")
public User getUser(Long id) {
    return userService.getById(id); // 正常调用
}

// 兜底方法：熔断后返回默认值
public User getUserFallback(Long id, Throwable e) {
    return new User(id, "系统繁忙，请稍后重试");
}
```

**🎤 面试这样答**：
> "熔断是当下游服务故障率超过阈值时自动切断调用，防止故障级联扩散，类似保险丝。降级是熔断后返回兜底响应，保证核心流程可用。熔断器有关闭、打开、半开三种状态，会自动试探恢复。Sentinel 是目前主流的流量控制组件，支持限流、熔断降级、热点参数限流和系统保护，通过注解 @SentinelResource 配合 fallback 方法实现降级。"

---

### 5. 网关的作用？

> ⭐⭐⭐⭐ 高频 | 难度：⭐⭐

**一句话回答**：网关是微服务的统一入口，负责路由转发、鉴权、限流、日志等横切功能。Spring Cloud Gateway 是目前主流的网关组件。

**通俗理解**：网关就像小区的门卫，所有人进出都要经过门卫。门卫负责查身份证（鉴权）、指路（路由）、限制人流（限流）、登记来访记录（日志）。

**回到技术**："查身份证"就是在网关层统一校验 Token/JWT，不用每个微服务都写鉴权逻辑。"指路"就是根据请求路径把请求路由到对应的微服务实例。"限制人流"就是通过限流算法（如令牌桶）控制请求速率，保护后端服务。

| 核心功能 | 说明 |
|---------|------|
| **路由转发** | 根据请求路径转发到对应的微服务 |
| **统一鉴权** | 在网关层统一校验 Token，不用每个服务都写鉴权逻辑 |
| **限流** | 控制请求速率，保护后端服务 |
| **跨域处理** | 统一处理 CORS，不用每个服务单独配置 |
| **日志监控** | 统一记录请求日志，方便排查问题 |

> **Gateway vs Nginx**：Nginx 做的是反向代理和负载均衡，偏运维层面；Gateway 做的是业务网关，能和 Spring Cloud 生态（注册中心、熔断）深度集成。生产环境通常是 ⚡**Nginx + Gateway** 配合使用。

**🎤 面试这样答**：
> "网关是微服务的统一入口，核心功能有路由转发、统一鉴权、限流和日志监控。Spring Cloud Gateway 是目前主流方案，基于 WebFlux 异步非阻塞。生产环境通常 Nginx 做反向代理和负载均衡，Gateway 做业务网关处理鉴权限流等逻辑。"

---

## 三、服务通信

### 6. 微服务之间怎么通信？OpenFeign 和 Dubbo 的区别？

> ⭐⭐⭐ 常问 | 难度：⭐⭐

**回答**：微服务之间的通信方式分两种——同步调用（HTTP/RPC）和异步消息（MQ）。简单说，OpenFeign 走 HTTP，Dubbo 走 RPC，Dubbo 性能更高但生态不如 Spring Cloud 完整。

| 对比项 | OpenFeign | Dubbo |
|--------|-----------|-------|
| 协议 | ⚡**HTTP**（RESTful） | ⚡**RPC**（自定义协议，默认 Dubbo 协议） |
| 性能 | 一般（HTTP 头部开销大） | ⚡**更高**（二进制序列化，长连接） |
| 使用方式 | 声明式接口，像调本地方法 | 声明式接口，像调本地方法 |
| 生态 | Spring Cloud 全家桶深度集成 | 独立生态，可整合 Spring Cloud |
| 适用场景 | 中小规模微服务 | 高性能、大规模服务调用 |

```java
// OpenFeign 声明式调用：像调本地方法一样调远程服务
@FeignClient(name = "user-service")
public interface UserClient {
    @GetMapping("/user/{id}")
    User getUser(@PathVariable Long id);
}
```

> **怎么选？** 如果用 Spring Cloud 全家桶，直接用 OpenFeign，简单够用。如果对性能要求高、服务调用量大，考虑 Dubbo。两者也可以混用。

---

## 面试高频程度排序（3~5 年）

| 优先级 | 题目 |
|--------|------|
| ⭐⭐⭐⭐⭐ | 什么是微服务？和单体的区别？ |
| ⭐⭐⭐⭐⭐ | Spring Cloud 核心组件？ |
| ⭐⭐⭐⭐⭐ | 服务注册与发现原理？Nacos vs Eureka？ |
| ⭐⭐⭐⭐⭐ | 熔断降级是什么？Sentinel？ |
| ⭐⭐⭐⭐ | 网关的作用？ |
| ⭐⭐⭐ | OpenFeign 和 Dubbo 的区别？ |